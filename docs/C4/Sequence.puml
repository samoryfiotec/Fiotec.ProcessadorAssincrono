@startuml AprovarDiariasLote
title Diagrama de Sequência - Aprovar Diárias em Lote com BackgroundService e Channel

actor "Aprovador" as approver
participant "Frontend (React)" as fe
participant "Minimal API" as api
participant "AprovacaoRequest" as dto
participant "IProcessadorQueue" as queue
participant "Channel<Aprovacao>" as channel
participant "BackgroundService" as worker
participant "IAprovacaoService" as service
database "DB SQL Server" as db

== Fluxo de Aprovação em Lote ==
approver -> fe: Seleciona múltiplas diárias
approver -> fe: Clica em "Aprovar em Lote"
fe -> api: PUT /api/diarias/{id}/aprovar [AprovacaoRequest]
activate api

api -> dto: Cria objeto AprovacaoRequest
api -> queue: EnfileirarAsync(id, pep, comentariosAdicionais, DataAprovacao)
activate queue
queue -> channel: WriteAsync(Aprovacao)
queue --> api: Confirma enfileiramento
deactivate queue

api --> fe: Retorna HTTP 202 Accepted
deactivate api
fe --> approver: Exibe mensagem de sucesso

== Processamento Assíncrono ==
loop para cada mensagem no Channel
    worker -> channel: ReadAsync()
    activate worker
    worker -> service: AprovarAsync(Id, Pep, ComentariosAdicionais, DataAprovacao)
    activate service
    service -> db: Atualiza status para "Aprovada"
    service -> db: Registra histórico de aprovação
    deactivate service
    worker --> channel: Mensagem processada
    deactivate worker
end

@enduml